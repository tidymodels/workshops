<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Machine learning with tidymodels - Annotations</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="Machine learning with tidymodels - Annotations">
<meta property="og:site-name" content="Machine learning with tidymodels">
<meta name="twitter:title" content="Machine learning with tidymodels - Annotations">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../index.html">
    <img src="../tidymodels.png" alt="">
    <span class="navbar-title">Machine learning with tidymodels</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-learn-more" role="button" data-bs-toggle="dropdown" aria-expanded="false">Learn more</a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-learn-more">    
        <li>
    <a class="dropdown-item" href="https://www.tidymodels.org/start/">
 <span class="dropdown-text">Get started at tidymodels.org</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://www.tmwr.org/">
 <span class="dropdown-text">Tidy Modeling with R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://supervised-ml-course.netlify.app/">
 <span class="dropdown-text">Online interactive course</span></a>
  </li>  
    </ul>
  </li>
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Annotations</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<section id="introduction" class="level1">
<h1>01 - Introduction</h1>
<section id="section" class="level2">
<h2 class="anchored" data-anchor-id="section">üëÄ</h2>
<p>This page contains <em>annotations</em> for selected slides.</p>
<p>There‚Äôs a lot that we want to tell you. We don‚Äôt want people to have to frantically scribble down things that we say that are not on the slides.</p>
<p>We‚Äôve added sections to this document with longer explanations and links to other resources.</p>
</section>
<section id="finalize-and-verify" class="level2">
<h2 class="anchored" data-anchor-id="finalize-and-verify">Finalize and verify</h2>
<p>This is a pretty complex data usage scheme. That is mostly because of the validation set. In every other case, the situation is much more simple.</p>
<p>The important point here is that: <strong>tidymodels does most of this work for you</strong>. In other words, you don‚Äôt have to directly specify which data are being used where.</p>
<p>In a later section, we will talk about methods of <a href="https://www.tmwr.org/resampling.html">resampling</a>. These methods are like repeated validation sets. As an example, the popular 10-fold cross-validation method is one such type of resampling. Validation sets are <a href="https://www.tmwr.org/resampling.html#validation">special cases of resampling</a> where there is a single ‚Äúresample‚Äù.</p>
<p>Most types of resampling use multiple hold-out sets of samples from the training set. In those cases, a diagram for data usage here would look like</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/whole-game-final-resamples.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>In this case there is just ‚Äútesting‚Äù and ‚Äútraining‚Äù. Once the final model is determined, the entire training set is used for the last fit.</p>
<p>This is the process that will be used for the tree frog data.</p>
</section>
</section>
<section id="data-budget" class="level1">
<h1>02 - Data Budget</h1>
<section id="data-splitting-and-spending" class="level2">
<h2 class="anchored" data-anchor-id="data-splitting-and-spending">Data splitting and spending</h2>
<p>What does <code>set.seed()</code> do?</p>
<p>We‚Äôll use pseudo-random numbers (PRN) to partition the data into training and testing. PRN are numbers that emulate truly random numbers (but really are not truly random).</p>
<p>Think of PRN as a box that takes a starting value (the ‚Äúseed‚Äù) that produces random numbers using that starting value as an input into its process.</p>
<p>If we know a seed value, we can reproduce our ‚Äúrandom‚Äù numbers. To use a different set of random numbers, choose a different seed value.</p>
<p>For example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">runif</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 0.2655087 0.3721239 0.5728534</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get a new set or random numbers:</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">runif</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 0.1848823 0.7023740 0.5733263</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We can reproduce the old ones with the same seed</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">runif</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 0.2655087 0.3721239 0.5728534</code></pre>
</div>
</div>
<p>If we <em>don‚Äôt</em> set the seeds, programs use the clock time as the seed. This isn‚Äôt reproducible.</p>
<p>Since we want our code to be reproducible, we set the seeds before random numbers are used.</p>
<p>In theory, you can set the seed once at the start of a script. However, if we do interactive data analysis, we might unwittingly use random numbers while coding. In that case, the stream is not the same and we don‚Äôt get reproducible results.</p>
<p>The value of the seed is an integer and really has no meaning. Max has a script to generate random integers to use as seeds to ‚Äúspread the randomness around‚Äù. It is basically:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">"set.seed("</span>, <span class="fu">sample.int</span>(<span class="dv">10000</span>, <span class="dv">5</span>), <span class="st">")"</span>, <span class="at">collapse =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; set.seed(9725)
#&gt; set.seed(8462)
#&gt; set.seed(4050)
#&gt; set.seed(8789)
#&gt; set.seed(1301)</code></pre>
</div>
</div>
</section>
</section>
<section id="what-makes-a-model" class="level1">
<h1>03 - What Makes A Model?</h1>
<section id="what-is-wrong-with-this" class="level2">
<h2 class="anchored" data-anchor-id="what-is-wrong-with-this">What is wrong with this?</h2>
<p>If we treat the preprocessing as a separate task, it raises the risk that we might accidentally overfit to the data at hand.</p>
<p>For example, someone might estimate something from the entire data set (such as the principle components) and treat that data as if it were know (and not estimated). Depending on the what was done with the data, consequences in doing that could be:</p>
<ul>
<li>You performance metrics are slightly-to-moderately optimistic (e.g.&nbsp;you might think your accuracy us 85% when it is actually 75%)</li>
<li>A consequential component of the analysis not right and the model just doesn‚Äôt work.</li>
</ul>
<p>The big issue here is that you won‚Äôt be able to figure this out until you get a new piece of data, such as the test set.</p>
<p>A really good example of this is in <a href="https://pubmed.ncbi.nlm.nih.gov/11983868/">‚ÄòSelection bias in gene extraction on the basis of microarray gene-expression data‚Äô</a>. The authors re-analyze a previous publication and show that the original researchers did not include feature selection in the workflow. Because of that, their performance statistics were extremely optimistic. In one case, they could do the original analysis of complete noise and achieve zero errors.</p>
<p>Generally speaking, this problem is referred to as <a href="https://en.wikipedia.org/wiki/Leakage_(machine_learning)">data leakage</a>. Some other references:</p>
<ul>
<li><a href="https://bookdown.org/max/FES/selection-overfitting.html">Overfitting to Predictors and External Validation</a></li>
<li><a href="https://datasets-benchmarks-proceedings.neurips.cc/paper/2021/hash/757b505cfd34c64c85ca5b5690ee5293-Abstract-round2.html">Are We Learning Yet? A Meta Review of Evaluation Failures Across Machine Learning</a></li>
<li><a href="https://scholar.google.com/scholar?hl=en&amp;as_sdt=0%2C5&amp;q=Navigating+the+pitfalls+of+applying+machine+learning+in+genomics&amp;btnG=">Navigating the pitfalls of applying machine learning in genomics</a></li>
<li><a href="https://academic.oup.com/bioinformatics/article/23/19/2507/185254">A review of feature selection techniques in bioinformatics</a></li>
<li><a href="https://www.jmlr.org/papers/volume11/cawley10a/cawley10a.pdf">On Over-fitting in Model Selection and Subsequent Selection Bias in Performance Evaluation</a></li>
</ul>
</section>
<section id="where-are-the-fitted-models" class="level2">
<h2 class="anchored" data-anchor-id="where-are-the-fitted-models">Where are the fitted models?</h2>
<p>The primary purpose of resampling is to estimate model performance. The models are almost never needed again.</p>
<p>Also, if the data set is large, the model object may require a lot of memory to save so, by default, we don‚Äôt keep them.</p>
<p>For more advanced use cases, you can extract and save them. See:</p>
<ul>
<li><a href="https://www.tmwr.org/resampling.html#extract" class="uri">https://www.tmwr.org/resampling.html#extract</a></li>
<li><a href="https://www.tidymodels.org/learn/models/coefficients/" class="uri">https://www.tidymodels.org/learn/models/coefficients/</a> (an example)</li>
</ul>
</section>
</section>
<section id="evaluating-models" class="level1">
<h1>04 - Evaluating Models</h1>
<section id="the-final-fit" class="level2">
<h2 class="anchored" data-anchor-id="the-final-fit">The final fit</h2>
<p>Since our data spending scheme created the resamples from the training set, <code>last_fit()</code> will use all of the training data to fit the final workflow.</p>
<p>As shown in the Whole Game slides, there is a slightly different scheme used when we have a validation set (instead of multiple resamples like 10-fold CV).</p>
</section>
</section>
<section id="feature-engineering" class="level1">
<h1>05 - Feature Engineering</h1>
<section id="splitting-the-nhl-data" class="level2">
<h2 class="anchored" data-anchor-id="splitting-the-nhl-data">Splitting the NHL data</h2>
<p><code>nhl_train</code> isn‚Äôt really the right name for these data.</p>
<p>In a little bit, we‚Äôll use the <code>validation_split()</code> function to take the rows in <code>nhl_train</code> and make a validation set. The data that are not used in the validation set are the data that we will use to build the models during tuning.</p>
<p>Recall the Whole Game slide had:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/whole-game-split.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p><code>nhl_train</code> has the ‚ÄúNot Testing‚Äù data.</p>
</section>
<section id="angle" class="level2">
<h2 class="anchored" data-anchor-id="angle">Angle</h2>
<p>About these formulas‚Ä¶</p>
<p>The coordinates for the rink are centered at <code>(0, 0)</code> and the goal lines are both 89 ft from center. The center of the goal on the left is at <code>(-89, 0)</code> and the right-hand goal is centered at <code>(89, 0)</code>.</p>
<p>For the distance to center ice, the formula is</p>
<p><span class="math display">\[d_{center} = \sqrt{x^2 + y^2}\]</span></p>
<p>We want distance to the goal line(s), so we first use <code>x* = (89 - abs(coord_x))</code> to make the side of the rink irrelevant and then compute</p>
<p><span class="math display">\[d_{goal} = \sqrt{x^{*2} + y^2}\]</span></p>
<p>In the code, we log the distance value to help its distribution become more symmetric.</p>
<p>For angle to center, the formula is</p>
<p><span class="math display">\[a = \tan^{-1}\left(\frac{y}{x}\right)\]</span></p>
<p>This is in radian units and we can convert to degrees using</p>
<p><span class="math display">\[a = \frac{180}{\pi}\tan^{-1}\left(\frac{y}{x}\right)\]</span></p>
<p>For the angle to the goal, we need to alter <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> again. We‚Äôll use <span class="math inline">\(x^*\)</span> from above and also use the absolute value of <span class="math inline">\(y\)</span> so that the degrees range from 0 to 180.</p>
</section>
</section>
<section id="tuning-hyperparameters" class="level1">
<h1>06 - Tuning Hyperparameters</h1>
<section id="update-parameter-ranges" class="level2">
<h2 class="anchored" data-anchor-id="update-parameter-ranges">Update parameter ranges</h2>
<p>In about 90% of the cases, the dials function that you use to update the parameter range has the same name as the argument. For example, if you were to update the <code>mtry</code> parameter in a random forests model, the code would look like</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>parameter_object <span class="sc">%&gt;%</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update</span>(<span class="at">mtry =</span> <span class="fu">mtry</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">100</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In our case, the argument name is <code>deg_free</code> but we update it with <code>spline_degree</code>.</p>
<p><code>deg_free</code> represents the general concept of degrees of freedom and could be associated with many different things. For example, if we ever had an argument that was the number of degrees of freedom for a <span class="math inline">\(t\)</span> distribution, we would call that argument <code>deg_free</code>.</p>
<p>For splines, we probably want a wider range for the degrees of freedom. We made a specialized function called <code>spline_degree()</code> to be used in these cases.</p>
<p>How can you tell when this happens? There is a helper function called <code>tunable()</code> and that gives information on how we make the default ranges for parameters. There is a column in these objects names <code>call_info</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>ns_tunable <span class="ot">&lt;-</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(mpg <span class="sc">~</span> ., <span class="at">data =</span> mtcars) <span class="sc">%&gt;%</span> </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_ns</span>(dis, <span class="at">deg_free =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tunable</span>()</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>ns_tunable</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 1 √ó 5
#&gt;   name     call_info        source component component_id
#&gt;   &lt;chr&gt;    &lt;list&gt;           &lt;chr&gt;  &lt;chr&gt;     &lt;chr&gt;       
#&gt; 1 deg_free &lt;named list [3]&gt; recipe step_ns   ns_P1Tjg</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>ns_tunable<span class="sc">$</span>call_info</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [[1]]
#&gt; [[1]]$pkg
#&gt; [1] "dials"
#&gt; 
#&gt; [[1]]$fun
#&gt; [1] "spline_degree"
#&gt; 
#&gt; [[1]]$range
#&gt; [1]  1 15</code></pre>
</div>
</div>
</section>
<section id="spline-grid-search" class="level2">
<h2 class="anchored" data-anchor-id="spline-grid-search">Spline grid search</h2>
<p>What‚Äôs going on with the</p>
<blockquote class="blockquote">
<p>prediction from a rank-deficient fit may be misleading</p>
</blockquote>
<p>warnings?</p>
<p>For linear regression, a computation is used called <em>matrix inversion</em>. The matrix in question is called the ‚Äúmodel matrix‚Äù and it contains the predictor set for the training data.</p>
<p>Matrix inverse can fail if two or model columns:</p>
<ul>
<li>are identical, or</li>
<li>add up to some other column.</li>
</ul>
<p>These situations are called <em>linear dependencies</em>.</p>
<p>When this happens, <code>lm()</code> is pretty tolerant. It does not fail but does not compute regression coefficients for a minimal number of predictors involved in the dependency (and issues the warning above).</p>
<p>For these data, there are three dependencies between:</p>
<ul>
<li><code>defense_team_PIT</code> and <code>offense_team_PIT</code></li>
<li><code>strength_short_handed</code>, <code>player_diff</code>, and <code>strength_power_play</code></li>
<li><code>year</code>, <code>month_Oct</code>, <code>month_Nov</code>, and <code>month_Dec</code></li>
</ul>
<p>The first one is easy to explain. For each row, when one these two <code>PIT</code> column has a one, the other must have a zero. The linear regression intercept is represented in the model matrix as a column of all ones. The dependency is</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>(Intercept) <span class="ot">=</span> defense_team_PIT <span class="sc">+</span> offense_team_PIT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The way to avoid this problem is to use <code>step_lincomb(all_numeric_predictors())</code> in the recipe. <a href="https://recipes.tidymodels.org/reference/step_lincomb.html">This step</a> removes the minimum number of columns to avoid the issue.</p>
<p><strong>tl;dr</strong></p>
<p>Linear regression detects some redundancies in the predictor set. We can ignore the warnings since <code>lm()</code> can deal with it or use <a href="https://recipes.tidymodels.org/reference/step_lincomb.html"><code>step_lincomb()</code></a> to avoid the warnings.</p>
</section>
<section id="boosted-tree-tuning-parameters" class="level2">
<h2 class="anchored" data-anchor-id="boosted-tree-tuning-parameters">Boosted tree tuning parameters</h2>
<p>When the deciding on number of boosting iterations, there are two main strategies:</p>
<ul>
<li><p>Directly tune it (<code>trees = tune()</code>)</p></li>
<li><p>Set it to one value and tune the number of early stopping iterations (<code>trees = 500</code>, <code>stop_iter = tune()</code>).</p></li>
</ul>
<p>Early stopping is when we monitor the performance of the model. If the model gets worse for at least <code>stop_iter</code> iterations, training stops.</p>
<p>Here‚Äôs an example where, after eleven iterations, performance starts to get worse.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="annotations_files/figure-html/early-stopping-1.svg" class="img-fluid"></p>
</div>
</div>
<p>This is likely do to over-fitting so we stop the model at eleven boosting iterations.</p>
<p>Early stopping usually has good results and takes far less time.</p>
</section>
<section id="boosted-tree-code" class="level2">
<h2 class="anchored" data-anchor-id="boosted-tree-code">Boosted tree code</h2>
<p>We set an engine argument called <code>validation</code> here. That‚Äôs not an argument to any function in the xgboost package.</p>
<p>parsnip has its own wrapper around (<code>xgboost::xgb.train()</code>) called <code>xgb_train()</code>. We use that here and it has a <code>validation</code> argument.</p>
<p>How would you know that? There are a few different ways:</p>
<ul>
<li>Look at the documentation in <code>?boost_tree</code> and click on the <code>xgboost</code> entry in the engine list.</li>
<li>Check out the pkgdown reference website <a href="https://parsnip.tidymodels.org/reference/index.html" class="uri">https://parsnip.tidymodels.org/reference/index.html</a></li>
<li>Run the <code>translate()</code> function on the parsnip specification object.</li>
</ul>
<p>The first two options are best since they tell you a lot more about the particularities of each model engine (there are a lot for xgboost).</p>
</section>
<section id="the-final-fit-to-the-nhl-data" class="level2">
<h2 class="anchored" data-anchor-id="the-final-fit-to-the-nhl-data">The final fit to the NHL data</h2>
<p>Recall that <code>last_fit()</code> uses the objects produced by <code>initial_fit()</code> to determine what data are used for the final model fit and which are used as the test set.</p>
<p>For the validation set, <code>last_fit()</code> will use the non-testing data to create the final model fit. This includes the training and validation set.</p>
<p>There is no agreement in the community on whether this is the best approach or if we should just use the training set. There are good arguments either way.</p>
<p>If you only want to use the training set for the final model, you can do this via:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>training_data <span class="ot">&lt;-</span> nhl_val<span class="sc">$</span>splits[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> <span class="fu">analysis</span>()</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Use `fit()` to train the model on just the training set</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>final_glm_spline_wflow <span class="ot">&lt;-</span> </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  glm_spline_wflow <span class="sc">%&gt;%</span> </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> training_data)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create test set predictions</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>test_set_pred <span class="ot">&lt;-</span> <span class="fu">augment</span>(final_glm_spline_wflow, nhl_test)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup and compute the test set metrics</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>cls_metrics <span class="ot">&lt;-</span> <span class="fu">metric_set</span>(roc_auc, accuracy)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>test_res <span class="ot">&lt;-</span> </span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  test_set_pred <span class="sc">%&gt;%</span> </span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cls_metrics</span>(on_goal, <span class="at">estimate =</span> .pred_class, .pred_yes)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>test_res</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Proudly supported by <a href="https://www.rstudio.com"><img src="https://www.rstudio.com/wp-content/uploads/2018/10/RStudio-Logo-flat.svg" class="img-fluid" alt="RStudio" width="65"></a></div>   
  </div>
</footer>



</body></html>